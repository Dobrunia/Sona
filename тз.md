# Музыкальный сервис (MVP → Production-ready)

## 1. Цель проекта

Веб-сервис для загрузки, прослушивания и поиска пользовательской музыки  
с поддержкой лайков, избранного и отображением онлайн-пользователей.

Проект реализуется как SPA с постоянным аудиоплеером.  
Верстка обязательно адаптивная и полностью корректно работающая на мобильных устройствах.

---

# 2. Архитектура

## 2.1 Общая схема

Frontend (SPA)

- Vue 3
- Pinia
- Vuetify v4
- Vite

Backend

- Node.js
- GraphQL API
- Prisma
- PostgreSQL

Хранилище файлов

- Удалённое S3-совместимое хранилище: **Yandex Object Storage**
- Ничего локально не поднимается
- Файлы хранятся в облаке
- Доступ через S3 API

Realtime

- WebSocket (для онлайн-статуса и текущего трека)

Примечание (MVP):

- Redis не используется
- Онлайн-пользователи хранятся в памяти backend
- При перезапуске сервера онлайн сбрасывается

---

# 3. Стек

## Frontend

- Vue 3
- Pinia
- Vuetify v4
- Vite
- Apollo Client

## Backend

- Node.js
- GraphQL
- Prisma
- PostgreSQL
- WebSocket

## Хранение файлов

- **Yandex Object Storage**
- Доступ через S3 SDK
- Использование presigned URL для загрузки
- Поддержка HTTP Range для стриминга

---

# 4. Работа с Yandex Object Storage

## Загрузка файлов (рекомендуемый поток)

1. Frontend запрашивает у backend presigned URL(ы)
2. Backend генерирует presigned URL(ы) для Yandex Object Storage
3. Frontend загружает файлы напрямую в Object Storage:
   - mp3 (обязательно)
   - обложку (опционально)
4. Backend сохраняет в БД:
   - ключ mp3 файла (fileKey)
   - ключ обложки (coverKey) — если загружена
   - длительность
   - размер(а)
   - метаданные

## Хранение в БД

В БД хранится:

- fileKey (ключ объекта mp3)
- coverKey (ключ объекта обложки, nullable)
- либо публичные URL (если используется публичный бакет)

## Требования

- бакет приватный
- доступ к файлам через presigned GET URL
- ограниченный срок действия ссылок

---

# 5. Функционал (MVP)

## 5.1 Авторизация

- Только Google OAuth
- JWT access token
- Refresh token

---

## 5.2 Загрузка трека

Любой авторизованный пользователь может:

- загрузить mp3
- указать название
- опционально указать исполнителя
- опционально загрузить обложку (картинку)

### Ограничения (mp3)

- только mp3
- длительность до 10 минут
- максимальный размер 20MB
- серверная проверка MIME-типа
- серверная проверка длительности (ffprobe)

### Ограничения (обложка)

- опционально
- формат: jpg/jpeg/png/webp
- максимальный размер (например 2MB)
- серверная проверка MIME-типа
- при необходимости — ресайз/оптимизация на backend (опционально для MVP)

### Дополнительно

- отображение прогресса загрузки
- drag & drop

---

## 5.3 Прослушивание

- Потоковое воспроизведение
- Использование HTTP Range
- Получение временного presigned GET URL
- Глобальный аудиоплеер
- Плеер не перезагружается при навигации
- Сохраняется состояние трека

---

## 5.4 Лайки

- Лайк добавляет трек в избранное
- Повторный лайк снимает отметку
- Уникальность (userId + trackId)

---

## 5.5 Поиск

- По названию
- По исполнителю
- Пагинация 10 на странице
- Индексы в БД
- Debounce на frontend

---

## 5.6 Избранное

- Пагинация 20
- Сортировка по дате лайка

---

## 5.7 Онлайн пользователи

- Количество онлайн в шапке
- Список пользователей
- Отображение текущего трека

### Реализация (MVP)

- WebSocket
- Хранение online в памяти backend (Map)
- Heartbeat
- Очистка при disconnect

---

# 6. База данных

## User

- id
- email (unique)
- name
- avatar - если есть
- createdAt

## Track

- id
- title (index)
- artist (index) - тоже опционально
- fileKey
- **coverKey (nullable)**
- duration
- fileSize
- **coverSize (nullable)**
- playCount
- createdAt
- uploadedBy

## Like

- id
- userId
- trackId
- createdAt
- unique(userId, trackId)

---

# 7. Адаптивность (ВАЖНО)

Интерфейс должен быть полностью адаптирован под мобильные устройства.

## Требования

- Mobile-first подход
- Поддержка экранов от 320px ширины
- Корректная работа на iOS Safari и Android Chrome
- Фиксированный нижний плеер на мобильных
- Упрощённая навигация (иконки вместо текста при необходимости)
- Touch-friendly элементы (минимум 44px высота кликабельных элементов)
- Отсутствие горизонтального скролла
- Адаптивные списки и карточки
- Адаптивная пагинация
- Обложки треков адаптивно обрезаются (cover / contain) без “ломания” сетки

---

# 8. UI/UX

- Минималистичный стиль (похожий на X)
- Максимум 2 типа кнопок
- Единый стиль карточек
- Skeleton loader
- Toast уведомления
- Empty states
- Error states

---

# 9. Нефункциональные требования

- 1000 одновременных пользователей (MVP ориентир)
- Старт воспроизведения < 500мс
- Поиск < 200мс
- Rate limiting на загрузку

---

# 10. Качество кода

- Без магических чисел
- Переиспользуемые компоненты
- Атомарная структура
- Разделение UI и логики
- TypeScript
- ESLint + Prettier
- Чистая архитектура

---

# 11. Ограничения

- Только mp3
- До 10 минут
- До 20MB
- Обложка опционально (до 2MB)
- Онлайн без Redis (MVP)

---

# 12. Возможное развитие

- Redis для online и масштабирования
- CDN перед Yandex Object Storage
- Плейлисты
- Очередь воспроизведения
- Shuffle
- Recently played
- Рекомендации
